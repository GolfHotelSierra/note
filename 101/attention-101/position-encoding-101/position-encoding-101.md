[toc]

# 位置编码

- Attention 不能体现出距离/时序上的差别；位置信息包括，比如，

  - <u>*绝对位置信息*</u>。$a_1$ 是第一个 token，$a_2$ 是第二个 token 等
  - <u>*相对位置信息*</u>。$a_2$ 在 $a_1$ 的后面一位，$a_4$ 在 $a_2$ 的后面两位等
  - <u>*不同位置间的距离*</u>。$a_1$ 和 $a_3$ 差的位置是 2，$a_1$ 和 $a_4$ 差的位置是 3 等
- 一般地，位置编码的融合方式是**加法融合**





# 三角 sinusoidal / sin-cos 位置编码

- 不难想到，可以使用二进制编码表示位置信息，

  <img src="assets/v2-60d7a554b442eebe967d8e07eb941039_r.jpg" alt="v2-60d7a554b442eebe967d8e07eb941039_r" style="zoom:50%;" />

  但是二进制编码不连续 (i.e. 不够平滑)，相邻位置之间的编码差异可能很大

- 仔细观察，二进制编码的核心是<u>*从低位到高位变化频率逐渐变慢*</u>

  放到三角函数上，是从低位到高位波长逐渐变长

  > 对于三角函数来说，比如 $\sin(\alpha x)$，<u>*$\alpha$ 越小，波长越长*</u>，变化频率越慢

  另一方面，三角函数存在周期性，这可能导致位置信息不准确，一般需要<u>*尽可能长的波长*</u>以保证在一个周期内

  综上，将<u>*位置为 $t$ 的位置向量*</u>设置为，

  <img src="assets/image-20240913193457858.png" alt="image-20240913193457858" style="zoom: 45%;" />

  <img src="assets/image-20240913193513230.png" alt="image-20240913193513230" style="zoom:45%;" />



# 旋转位置编码 RoPE

- sinusoidal 位置编码可以看做是使用三角函数 (模仿二进制编码) 表示绝对位置和相对位置

  而 <u>*RoPE*</u> 则是<u>*通过旋转来表示绝对位置和相对位置*</u>

- 通过下面这个假设，

  <img src="assets/image-20250306220049258.png" alt="image-20250306220049258" style="zoom:50%;" />

  $q$, $k$ 表示 token，$m$, $n$ 表示下标；$m-n$ 表示希望在<u>*计算点积的过程*</u>中，函数 $f$ 能够表达出相对位置

  经过一系列数学推导，得到函数 $f$ 为，

  <img src="assets/image-20250306220233375.png" alt="image-20250306220233375" style="zoom:50%;" />

  而矩阵 $R_m$ 恰好就是一个旋转矩阵，表示将<u>*向量顺指针旋转*</u> $m\theta$ 弧度 (旋转不同的弧度就可以表示绝对位置)

- 通过计算点积，

  <img src="assets/2025年3月6日220623.png" alt="2025年3月6日220623" style="zoom: 30%;" />

  旋转矩阵中同样会<u>*包含 $m-n$ 的相对位置信息*</u>；而在<u>*计算 attn 的过程中会使用到点积运算*</u> (i.e. 在计算 attn 的过程中，绝对位置编码会自然包含相对位置信息)
